# /Users/user/Desktop/Core Guild Project/projects/colabs/eng-teams/core/personal-website/prototype/.github/workflows/deploy-hotfix.yml
# Hotfix deployment workflow with multiple deployment methods and correct Hostinger formats
name: ğŸš‘ Hotfix Deploy

on:
  workflow_dispatch:
    inputs:
      deployment_method:
        description: 'Choose deployment method'
        required: true
        default: 'debug-and-deploy'
        type: choice
        options:
        - debug-and-deploy
        - auto-detect-server
        - ftp-hostinger-v2
        - ftp-ip-fallback
        - sftp-secure
        - manual-debug

jobs:
  deploy-hotfix:
    name: ğŸš‘ Emergency Deploy
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“‹ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: ğŸ“š Install dependencies
        run: npm ci
        
      - name: ğŸ—ï¸ Build application
        run: npm run build
        
      - name: ğŸ“ Prepare deployment directory
        run: |
          mkdir -p deployment
          cp -r out/* deployment/
          echo "ğŸ“ Deployment files prepared:"
          ls -la deployment/
          echo "ğŸ“„ Checking index.html content:"
          head -5 deployment/index.html
          echo "ğŸ“Š Total files to deploy:"
          find deployment/ -type f | wc -l
          
      - name: ğŸ” Debug and Deploy with Verification
        if: ${{ github.event.inputs.deployment_method == 'debug-and-deploy' }}
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server: files.hostinger.com
          username: ${{ secrets.HOSTINGER_FTP_USERNAME }}
          password: ${{ secrets.HOSTINGER_FTP_PASSWORD }}
          local-dir: ./deployment/
          server-dir: ./public_html/
          protocol: ftp
          port: 21
          log-level: verbose
          dry-run: false
          dangerous-clean-slate: true
          
      - name: ğŸ§ª Post-Deploy Verification
        if: ${{ github.event.inputs.deployment_method == 'debug-and-deploy' }}
        run: |
          echo "â³ Waiting 30 seconds for propagation..."
          sleep 30
          echo "ğŸŒ Testing website accessibility:"
          curl -I https://caiocastilho.com || echo "âŒ Site not accessible yet"
          echo "ğŸ” Testing if our content is live:"
          curl -s https://caiocastilho.com | grep -q "Caio A. S. Castilho" && echo "âœ… Our content is live!" || echo "âŒ Still showing default page"
          
      - name: ğŸ” Auto-Detect Server Format
        if: ${{ github.event.inputs.deployment_method == 'auto-detect-server' }}
        run: |
          echo "ğŸ” Testing server connectivity..."
          echo "Testing format 1: files.hostinger.com"
          ping -c 2 files.hostinger.com || echo "âŒ files.hostinger.com failed"
          echo "Testing format 2: IP address"
          ping -c 2 185.239.210.65 || echo "âŒ IP address failed"
          echo "Testing format 3: ftp.hostinger.com"
          ping -c 2 ftp.hostinger.com || echo "âŒ ftp.hostinger.com failed"
          echo "ğŸ“ Use the working server format in GitHub Secrets"
          
      - name: ğŸš€ Deploy via files.hostinger.com
        if: ${{ github.event.inputs.deployment_method == 'auto-detect-server' }}
        continue-on-error: true
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server: files.hostinger.com
          username: ${{ secrets.HOSTINGER_FTP_USERNAME }}
          password: ${{ secrets.HOSTINGER_FTP_PASSWORD }}
          local-dir: ./deployment/
          server-dir: ./public_html/
          protocol: ftp
          port: 21
          log-level: verbose
          
      - name: ğŸš€ Deploy via IP Fallback (if first failed)
        if: ${{ github.event.inputs.deployment_method == 'auto-detect-server' && failure() }}
        continue-on-error: true
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server: 185.239.210.65
          username: ${{ secrets.HOSTINGER_FTP_USERNAME }}
          password: ${{ secrets.HOSTINGER_FTP_PASSWORD }}
          local-dir: ./deployment/
          server-dir: ./public_html/
          protocol: ftp
          port: 21
          log-level: verbose
          
      - name: ğŸš€ Deploy via Hostinger FTP (Correct Format)
        if: ${{ github.event.inputs.deployment_method == 'ftp-hostinger-v2' }}
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server: ${{ secrets.HOSTINGER_FTP_SERVER }}
          username: ${{ secrets.HOSTINGER_FTP_USERNAME }}
          password: ${{ secrets.HOSTINGER_FTP_PASSWORD }}
          local-dir: ./deployment/
          server-dir: ./public_html/
          protocol: ftp
          port: 21
          log-level: verbose
          
      - name: ğŸš€ Deploy via IP Fallback
        if: ${{ github.event.inputs.deployment_method == 'ftp-ip-fallback' }}
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server: 185.239.210.65
          username: ${{ secrets.HOSTINGER_FTP_USERNAME }}
          password: ${{ secrets.HOSTINGER_FTP_PASSWORD }}
          local-dir: ./deployment/
          server-dir: ./public_html/
          protocol: ftp
          port: 21
          log-level: verbose
          
      - name: ğŸ”’ Deploy via SFTP (Secure)
        if: ${{ github.event.inputs.deployment_method == 'sftp-secure' }}
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server: ${{ secrets.HOSTINGER_FTP_SERVER }}
          username: ${{ secrets.HOSTINGER_FTP_USERNAME }}
          password: ${{ secrets.HOSTINGER_FTP_PASSWORD }}
          local-dir: ./deployment/
          server-dir: ./public_html/
          protocol: sftp
          port: 22
          log-level: verbose
          
      - name: ğŸ” Debug Connection Info
        if: ${{ github.event.inputs.deployment_method == 'manual-debug' }}
        run: |
          echo "ğŸ” Testing connection parameters..."
          echo "ğŸŒ Testing server connectivity..."
          echo "ğŸ“ Credential format verification needed"
          echo "âš ï¸  Check hPanel for correct FTP details"
          echo "ğŸ”§ Server should be hostname, not IP"
          echo "ğŸ‘¤ Username should be format: u12345678"
          echo "ğŸ”‘ Password should be FTP password (not SSH)"
          echo ""
          echo "ğŸ§ª Testing common Hostinger server formats:"
          ping -c 2 files.hostinger.com || echo "âŒ files.hostinger.com failed"
          ping -c 2 ftp.hostinger.com || echo "âŒ ftp.hostinger.com failed" 
          ping -c 2 185.239.210.65 || echo "âŒ IP failed"
          
      - name: âœ… Deployment Success
        if: success()
        run: |
          echo "ğŸ‰ Deployment completed successfully!"
          echo "ğŸŒ Website should be live at: https://caiocastilho.com"
          echo "â° Allow 2-5 minutes for propagation" 